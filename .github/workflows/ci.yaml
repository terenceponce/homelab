name: CI

on:
  pull_request:
    branches:
      - main

env:
  KUBECONFORM_ARGS: >-
    -strict -summary -output text
    -schema-location default
    -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'
    -skip Secret

jobs:
  validate-kustomize:
    name: Validate Kustomize
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main

      - name: Setup kubeconform
        uses: fluxcd/pkg/actions/kubeconform@main

      - name: Build apps overlay
        run: kustomize build apps/overlays/production > /tmp/apps.yaml

      - name: Validate apps overlay
        run: kubeconform $KUBECONFORM_ARGS /tmp/apps.yaml

      - name: Build infrastructure overlay
        run: kustomize build infrastructure/overlays/production > /tmp/infrastructure.yaml

      - name: Validate infrastructure overlay
        run: kubeconform $KUBECONFORM_ARGS /tmp/infrastructure.yaml

      - name: Build cluster manifests
        run: kustomize build clusters/production/flux-system > /tmp/flux-system.yaml

      - name: Validate cluster manifests
        run: kubeconform $KUBECONFORM_ARGS -skip CustomResourceDefinition /tmp/flux-system.yaml

  kube-linter:
    name: Kube Linter
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main

      - name: Build apps overlay
        run: |
          mkdir -p /tmp/manifests
          kustomize build apps/overlays/production > /tmp/manifests/apps.yaml

      - name: Build infrastructure overlay
        run: kustomize build infrastructure/overlays/production > /tmp/manifests/infrastructure.yaml

      - name: Run kube-linter
        uses: stackrox/kube-linter-action@v1
        with:
          directory: /tmp/manifests

  pluto:
    name: Detect Deprecated APIs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kustomize
        uses: fluxcd/pkg/actions/kustomize@main

      - name: Setup Pluto
        uses: FairwindsOps/pluto/github-action@master

      - name: Check apps overlay
        run: kustomize build apps/overlays/production | pluto detect -

      - name: Check infrastructure overlay
        run: kustomize build infrastructure/overlays/production | pluto detect -

      - name: Check cluster manifests
        run: kustomize build clusters/production/flux-system | pluto detect -
